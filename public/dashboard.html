<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TradingIndicatorPro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .welcome {
            color: #333;
            margin: 0;
        }
        
        .user-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #1976d2;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .subscription-status {
            background: #fff3e0;
            border: 1px solid #ff9800;
            color: #f57c00;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            font-size: 18px;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #0056b3;
        }
        
        .btn-danger {
            background-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="welcome">Dashboard</h1>
            <div>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
        
        <div id="user-content" class="loading">
            Loading your dashboard...
        </div>
    </div>

    <script>
        let currentUser = null;
        
        // Check if user is logged in
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    loadDashboard();
                } else {
                    // Not logged in, redirect to login
                    window.location.href = '/login.html';
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/login.html';
            }
        }
        
        // Load dashboard content
        function loadDashboard() {
            const content = document.getElementById('user-content');
            
            const subscriptionHTML = currentUser.hasActiveSubscription ? 
                `<div class="card">
                    <h3>‚úÖ Active Subscription</h3>
                    <div style="background: linear-gradient(45deg, #d4edda, #c3e6cb); padding: 20px; border-radius: 10px; text-align: center;">
                        <h2 style="color: #155724; margin: 0;">${currentUser.activePlan.name} Plan</h2>
                        <p style="font-size: 24px; font-weight: bold; color: #155724; margin: 10px 0;">${currentUser.daysRemaining} days remaining</p>
                        <p style="color: #155724; margin: 0;">
                            <strong>Started:</strong> ${new Date(currentUser.activePlan.startDate).toLocaleDateString()}<br>
                            <strong>Expires:</strong> ${new Date(currentUser.activePlan.endDate).toLocaleDateString()}<br>
                            <strong>Price Paid:</strong> ‚Çπ${currentUser.activePlan.price.toLocaleString()}
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="accessIndicator()" style="background: #28a745;">
                            üéØ Access Trading Indicator
                        </button>
                        <button onclick="window.location.href='/subscriptions.html'" style="background: #007bff;">
                            üìà Upgrade Plan
                        </button>
                    </div>
                </div>` :
                `<div class="card">
                    <h3>‚ùå No Active Subscription</h3>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 20px; border-radius: 10px; text-align: center;">
                        <h3>üöß Subscribe to Access TradingIndicatorPro</h3>
                        <p>Get professional trading indicators with 87% accuracy rate!</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="window.location.href='/subscriptions.html'" style="background: #007bff; font-size: 18px; padding: 15px 30px;">
                            üíé View Subscription Plans
                        </button>
                    </div>
                </div>`;
            
            content.innerHTML = `
                <div class="card">
                    <h2>üëã Welcome, ${currentUser.name}!</h2>
                    
                    <div style="background: #e3f2fd; border: 1px solid #2196f3; color: #1976d2; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <strong>Your Account Details:</strong><br>
                        <strong>Name:</strong> ${currentUser.name}<br>
                        <strong>Email:</strong> ${currentUser.email}<br>
                        <strong>Role:</strong> ${currentUser.role}<br>
                        <strong>Member Since:</strong> ${new Date().toLocaleDateString()}
                    </div>
                </div>
                
                ${subscriptionHTML}
                
                <div class="card">
                    <h3>üîß Quick Actions</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button onclick="testApiCall()">üß™ Test API</button>
                        <button onclick="showUserDetails()">üë§ User Details</button>
                        <button onclick="window.location.href='/subscriptions.html'" style="background: #17a2b8;">üìä View Plans</button>
                        ${currentUser.hasActiveSubscription ? 
                            '<button onclick="accessIndicator()" style="background: #28a745;">üéØ Access Indicator</button>' : 
                            ''
                        }
                    </div>
                </div>
            `;
        }
        
        // Access indicator (for subscribed users)
        function accessIndicator() {
            if (!currentUser.hasActiveSubscription) {
                alert('‚ùå You need an active subscription to access the indicator');
                return;
            }
            
            alert(`üéâ Indicator Access Granted!\n\nYour ${currentUser.activePlan.name} plan is active.\n\nTradingView Script ID: TIP_v2_${currentUser.activePlan.planId}\n\nüìã Instructions:\n1. Open TradingView\n2. Go to Pine Script Editor\n3. Add our indicator script\n4. Apply to your charts\n\nüí¨ Need help? Contact support!`);
        }
        
        // Test API call
        async function testApiCall() {
            try {
                const response = await fetch('/api/test');
                const data = await response.json();
                alert(`API Test Success: ${data.message}`);
            } catch (error) {
                alert('API Test Failed: ' + error.message);
            }
        }
        
        // Show user details
        function showUserDetails() {
            alert(`User Details:\n\nName: ${currentUser.name}\nEmail: ${currentUser.email}\nRole: ${currentUser.role}\nID: ${currentUser.id}`);
        }
        
        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Logged out successfully!');
                    window.location.href = '/';
                } else {
                    alert('Logout failed');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout error');
            }
        }
        
        // Initialize when page loads
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html>